name: Create MOSIP Cluster

on:
  push:
    branches:
      - main
      - develop

jobs:
  create-rke-cluster:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        node: [cluster]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup ufw firewall
        run: |
          sudo ufw enable
          sudo ufw allow ssh
          sudo ufw allow 51820/udp
          sudo ufw status        

      - name: Install WireGuard
        run: sudo apt-get install -y wireguard

      - name: Configure WireGuard
        run: |
          echo "[Interface]
          Address = 10.13.13.48
          PrivateKey = wMvm0VzqJzqL/rYPDcqGTjZ/z4LmAH0V2raHUZZZtks=
          ListenPort = 51820
          [Peer]
          PublicKey = fCCuRocmGjP/Fyp0use7WYJQM8sOLP1GNhun6QnW5Aw=
          Endpoint = 3.7.248.153:51820
          AllowedIPs = 172.31.0.0/16" | sudo tee /etc/wireguard/wg0.conf

      - name: Start WireGuard
        run: |
          sudo chmod 600 /etc/wireguard/wg0.conf
          sudo chmod 700 /etc/wireguard/
          sudo chmod 644 /lib/systemd/system/wg-quick@.service
          sudo systemctl daemon-reload
          sudo wg-quick up wg0
          sudo wg show wg0

      - name: Set up Python and install Ansible
        uses: actions/setup-python@v2
        with:
          python-version: 3.x

      - name: Install Ansible dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Configure SSH keys for password-less SSH connection.
        run: |
          echo "${{ secrets.CLUSTER_PRIVATE_KEY }}" > ssh_key
          chmod 600 ssh_key

      - name: Set ANSIBLE_HOST_KEY_CHECKING to False
        run: echo "export ANSIBLE_HOST_KEY_CHECKING=False" >> $GITHUB_ENV

      - name: Run Ansible playbook to perform Environment Check and setup.
        run: |
          ansible-playbook -i ./config/hosts.ini ./playbooks/env-check-setup.yaml

      - name: Run Ansible playbook to Install docker on all nodes.
        run: |
          ansible-playbook -i ./config/hosts.ini ./playbooks/docker.yaml

      - name: Build Docker image
        run: docker build -t mosip-rke-image .

      - name: Run RKE in Docker container
        run: docker run -v $(pwd):/config mosip-rke-image

      - name: Commit changes to cluster repository
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add -A
          git commit -m "Update RKE state and kubeconfig files"
          git push https://${{ secrets.CLUSTER_REPO_ACCESS }}@github.com/Mohanraj209/cluster main
